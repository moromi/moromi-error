version: 2

jobs:
  build: &build
    docker:
      - image: circleci/ruby:latest
    steps:
      - checkout
      - restore_cache:
          key: bundle
      - run:
          name: Install gems
          command: bundle install
      - save_cache:
          key: bundle
          paths:
            - vendor/bundle
      - run:
          name: Generate database.yml
          command: |
            echo 'test:
              adapter: sqlite3
              database: circle_ruby_test
              username: ubuntu
              host: localhost
            ' > config/database.yml
      - run:
          name: DB migrate
          command: |
            cd spec/dummy
            RAILS_ENV=test bundle exec rake db:migrate
      - run:
          name: RSpec
          command: |
            RAILS_ENV=test bundle exec rspec --color --format d --require spec_helper --require rails_helper
  ruby-2.4:
    <<: *build
    docker:
      - image: circleci/ruby:2.4

  ruby-2.5:
    <<: *build
    docker:
      - image: circleci/ruby:2.5

workflows:
  version: 2
  build-multiple-rubies:
    jobs:
      - ruby-2.4
      - ruby-2.5
